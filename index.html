<script>
// ===== Backend helper (global) =====
if (!window.DATA_API || !window.API_KEY) {
  document.getElementById('backendBanner')?.classList.remove('hidden');
}
window.backend = async function backend(action, payload = {}) {
  const res = await fetch(window.DATA_API, {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ key: window.API_KEY, action, payload })
  });
  return res.json();
};

// ===== Durable offline write queue =====
const QUEUE_KEY = 'pendingWrites';
let isFlushing = false;

function qLoad(){ return JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]'); }
function qSave(q){ localStorage.setItem(QUEUE_KEY, JSON.stringify(q)); }
function enqueue(action, payload){
  const q = qLoad();
  q.push({ action, payload, attempts:0, nextAttemptAt:0 });
  qSave(q);
}
function backoffMs(attempts){ return Math.min(60000, Math.pow(2, attempts) * 1000); }

async function flushQueue(){
  if (!navigator.onLine || isFlushing) return;
  isFlushing = true;
  try{
    let q = qLoad();
    if (!q.length) return;
    const now = Date.now();
    let progressed = false;
    for (let i=0; i<q.length; i++){
      const job = q[i];
      if ((job.nextAttemptAt||0) > now) continue;
      try{
        const r = await backend(job.action, job.payload);
        if (r && r.ok){
          q.splice(i,1); i--; progressed = true;
        }else{
          job.attempts = (job.attempts||0)+1;
          job.nextAttemptAt = Date.now() + backoffMs(job.attempts);
        }
      }catch(e){
        job.attempts = (job.attempts||0)+1;
        job.nextAttemptAt = Date.now() + backoffMs(job.attempts);
      }
    }
    qSave(q);
    if (progressed && q.length) await flushQueue();
  } finally {
    isFlushing = false;
  }
}
window.addEventListener('online', flushQueue);
setInterval(flushQueue, 5000);

// ===== App state helpers =====
const SKEY = (k) => `state.${k}`;
const state = {
  items: [], sales: [], grn: [], suppliers: [], users: [], settings: [],
  user: null, role: 'Guest', cart: [], business: { name:'AutoSpares Pro', address:'Plot 123, Main Road, Lusaka', cur:'K' }
};
function loadState(){
  for (const k of ['items','sales','grn','suppliers','users','settings']){
    const v = localStorage.getItem(SKEY(k));
    state[k] = v ? JSON.parse(v) : [];
  }
  const b = localStorage.getItem('business'); if (b) state.business = JSON.parse(b);
  const u = localStorage.getItem('auth.user'); if (u) { const {user,role}=JSON.parse(u); state.user=user; state.role=role; }
}
function saveStatePart(k, val){ state[k]=val; localStorage.setItem(SKEY(k), JSON.stringify(val)); }
function setBusiness(next){ state.business = { ...state.business, ...next }; localStorage.setItem('business', JSON.stringify(state.business)); }

// ===== Sync pull (global) =====
window.syncPull = async function syncPull(){
  const r = await backend('syncPull');
  if (r.ok){
    const d = r.data||{};
    for (const k of ['items','sales','grn','suppliers','users','settings']){
      localStorage.setItem(SKEY(k), JSON.stringify(d[k]||[]));
      state[k] = d[k]||[];
    }
    renderEverything();
  } else {
    console.warn('syncPull failed:', r.error);
  }
};

// ===== Convenience: safe write wrappers (use these) =====
async function saveItemsSafe(items){
  if (navigator.onLine){
    const r = await backend('upsertItems', items);
    if (!r.ok) enqueue('upsertItems', items);
  } else enqueue('upsertItems', items);
}
async function recordSaleSafe(lines){
  if (navigator.onLine){
    const r = await backend('recordSale', lines);
    if (!r.ok) enqueue('recordSale', lines);
  } else enqueue('recordSale', lines);
}
async function receiveGRNSafe(rows){
  if (navigator.onLine){
    const r = await backend('receiveGRN', rows);
    if (!r.ok) enqueue('receiveGRN', rows);
  } else enqueue('receiveGRN', rows);
}

// ===== UI wiring =====
const $ = (q) => document.querySelector(q);
const $$= (q) => Array.from(document.querySelectorAll(q));

function showPage(id){
  $$('#pages > div').forEach(el => el.classList.add('hidden'));
  $(`#page-${id}`)?.classList.remove('hidden');
}
function setRole(role){ state.role = role; $('#activeRole').textContent = `Role: ${role}`; }

// Nav
$('#nav')?.addEventListener('click', (e)=>{
  if (e.target?.dataset?.page) showPage(e.target.dataset.page);
});

// Demo login
const DEMO = { admin:{pass:'admin123',role:'Admin'}, manager:{pass:'manager123',role:'Manager'}, cashier:{pass:'cashier123',role:'Cashier'} };
$('#btnFillDemo')?.addEventListener('click', ()=>{
  $('#loginUser').value='admin'; $('#loginPass').value='admin123';
});
$('#btnLogin')?.addEventListener('click', ()=>{
  const u = $('#loginUser').value.trim().toLowerCase();
  const p = $('#loginPass').value;
  if (DEMO[u] && DEMO[u].pass===p){
    state.user = u; setRole(DEMO[u].role);
    localStorage.setItem('auth.user', JSON.stringify({user:u, role: state.role}));
    $('#page-login').classList.add('hidden'); showPage('dashboard'); renderEverything();
  } else {
    alert('Invalid credentials (try admin/admin123, manager/manager123, cashier/cashier123)');
  }
});
$('#btnLogout')?.addEventListener('click', ()=>{
  localStorage.removeItem('auth.user'); state.user=null; setRole('Guest'); location.reload();
});

// ===== Inventory =====
const itemModal = $('#itemModal');
function openItemModal(edit=null){
  $('#itemModalTitle').textContent = edit ? 'Edit Item' : 'New Item';
  $('#mSku').value   = edit?.sku   || '';
  $('#mName').value  = edit?.name  || '';
  $('#mMake').value  = edit?.make  || '';
  $('#mModel').value = edit?.model || '';
  $('#mCat').value   = edit?.category || '';
  $('#mBuy').value   = edit?.buy   ?? 0;
  $('#mSell').value  = edit?.sell  ?? 0;
  $('#mStock').value = edit?.stock ?? 0;
  $('#mReorder').value = edit?.reorder ?? 5;
  $('#mBin').value   = edit?.bin   || '';
  $('#mNotes').value = edit?.notes || '';
  itemModal.showModal();
}
$('#invAdd')?.addEventListener('click', ()=> openItemModal());
$('#mSave')?.addEventListener('click', async (ev)=>{
  ev.preventDefault();
  const item = {
    sku: $('#mSku').value.trim(),
    name: $('#mName').value.trim(),
    make: $('#mMake').value.trim(),
    model: $('#mModel').value.trim(),
    category: $('#mCat').value.trim(),
    buy: parseFloat($('#mBuy').value||0),
    sell: parseFloat($('#mSell').value||0),
    stock: parseInt($('#mStock').value||0),
    reorder: parseInt($('#mReorder').value||0),
    bin: $('#mBin').value.trim(),
    notes: $('#mNotes').value.trim()
  };
  if (!item.sku || !item.name){ alert('SKU and Item Name are required'); return; }
  await saveItemsSafe([item]);
  // optimistic local update
  const idx = state.items.findIndex(x => x.sku===item.sku);
  if (idx>=0) state.items[idx]=item; else state.items.push(item);
  saveStatePart('items', state.items);
  itemModal.close();
  renderInventory(); renderDashboard();
});
$('#invExport')?.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state.items, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'autospares_items.json';
  a.click();
});

// Inventory table render
function renderInventory(filter=''){
  const tb = $('#invTable tbody'); if (!tb) return;
  const kw = $('#invSearch').value.trim().toLowerCase();
  const rows = state.items
    .filter(it => !kw || [it.sku,it.name,it.make,it.model,it.category].join(' ').toLowerCase().includes(kw))
    .sort((a,b)=> (a.sku||'').localeCompare(b.sku||''));
  tb.innerHTML = rows.map(it=>`
    <tr class="border-b">
      <td>${it.sku||''}</td><td>${it.name||''}</td><td>${it.make||''} ${it.model||''}</td>
      <td>${(+it.buy||0).toFixed(2)}</td><td>${(+it.sell||0).toFixed(2)}</td>
      <td>${(+it.stock||0)}</td><td>${(+it.reorder||0)}</td><td>${it.bin||''}</td>
      <td class="no-print">
        <button class="px-2 py-1 border rounded" data-edit="${it.sku}">Edit</button>
      </td>
    </tr>`).join('');
  tb.querySelectorAll('[data-edit]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const sku = btn.getAttribute('data-edit');
      const it = state.items.find(x=>x.sku===sku);
      openItemModal(it);
    });
  });
}
$('#invSearch')?.addEventListener('input', ()=> renderInventory());

// ===== Suppliers =====
$('#supAdd')?.addEventListener('click', async ()=>{
  const s = {
    name: $('#supName').value.trim(),
    phone: $('#supPhone').value.trim(),
    email: $('#supEmail').value.trim()
  };
  if (!s.name){ alert('Supplier name required'); return; }
  await receiveSuppliers([s]);
});
async function receiveSuppliers(arr){
  if (navigator.onLine){
    const r = await backend('upsertSuppliers', arr);
    if (!r.ok) enqueue('upsertSuppliers', arr);
  } else enqueue('upsertSuppliers', arr);
  // optimistic local update
  for (const s of arr){
    const i = state.suppliers.findIndex(x=>x.name===s.name);
    if (i>=0) state.suppliers[i]=s; else state.suppliers.push(s);
  }
  saveStatePart('suppliers', state.suppliers);
  renderSuppliers(); fillSupplierSelect();
}
$('#supClear')?.addEventListener('click', ()=> { $('#supName').value=''; $('#supPhone').value=''; $('#supEmail').value=''; });
function renderSuppliers(){
  const tb = $('#supTable tbody'); if (!tb) return;
  tb.innerHTML = state.suppliers.map(s=>`
    <tr class="border-b"><td>${s.name||''}</td><td>${s.phone||''}</td><td>${s.email||''}</td><td></td></tr>
  `).join('');
}
function fillSupplierSelect(){
  const sel = $('#grnSupplier'); if (!sel) return;
  sel.innerHTML = `<option value="">Select supplier</option>` + state.suppliers.map(s=>`<option>${s.name}</option>`).join('');
}

// ===== GRN (Receive stock) =====
$('#grnAdd')?.addEventListener('click', async ()=>{
  const supplier = $('#grnSupplier').value.trim();
  const sku = $('#grnSku').value.trim();
  const qty = parseInt($('#grnQty').value||'1',10);
  if (!supplier || !sku || !qty){ alert('Supplier, SKU and Qty required'); return; }

  const row = { grnId: 'GRN-' + Date.now(), date: new Date().toISOString().slice(0,10), supplier, sku, qty, buy: 0, total: 0, clerk: state.user || 'system' };
  await receiveGRNSafe([row]);

  // adjust local stock
  const it = state.items.find(x=>x.sku===sku);
  if (it){ it.stock = (+it.stock||0)+qty; } else { alert('SKU not found in items; add the item first.'); }
  saveStatePart('items', state.items);

  // keep GRN list
  state.grn.unshift(row);
  saveStatePart('grn', state.grn);
  renderGRN();
  renderInventory();
  renderDashboard();
});
$('#grnClear')?.addEventListener('click', ()=>{
  $('#grnSupplier').value=''; $('#grnSku').value=''; $('#grnQty').value='1';
});
function renderGRN(){
  const ul = $('#grnList'); if (!ul) return;
  ul.innerHTML = state.grn.slice(0,10).map(g=>`<li> ${g.date} • <b>${g.sku}</b> × ${g.qty} from ${g.supplier}</li>`).join('');
}

// ===== POS (very small working version) =====
function posFind(term){
  const kw = term.toLowerCase();
  return state.items.filter(it => [it.sku,it.name,it.make,it.model,it.category].join(' ').toLowerCase().includes(kw));
}
$('#posSearch')?.addEventListener('input', ()=>{
  const box = $('#posSuggest');
  const txt = $('#posSearch').value.trim();
  if (!txt){ box.classList.add('hidden'); box.innerHTML=''; return; }
  const hits = posFind(txt).slice(0,20);
  box.innerHTML = hits.map(h=>`<div class="suggest-item" data-sku="${h.sku}">${h.sku} — ${h.name} (${h.sell||0})</div>`).join('');
  box.classList.toggle('hidden', hits.length===0);
  box.querySelectorAll('[data-sku]').forEach(d=> d.addEventListener('click', ()=> { addToCart(d.getAttribute('data-sku')); box.classList.add('hidden'); $('#posSearch').value=''; }));
});
$('#posAdd')?.addEventListener('click', ()=> {
  const sku = $('#posSku').value.trim(); if (!sku) return;
  addToCart(sku); $('#posSku').value='';
});
function addToCart(sku){
  const it = state.items.find(x=>x.sku===sku);
  if (!it){ alert('Item not found'); return; }
  const ex = state.cart.find(x=>x.sku===sku);
  if (ex){ ex.qty+=1; } else { state.cart.push({ sku: it.sku, name: it.name, price:+it.sell||0, qty:1 }); }
  renderCart();
}
function renderCart(){
  const tb = $('#posTable tbody'); if (!tb) return;
  tb.innerHTML = state.cart.map((l,i)=>`
    <tr class="border-b">
      <td>${l.sku}</td><td>${l.name}</td>
      <td><input type="number" min="0" value="${l.price}" data-price="${i}" class="w-24 border rounded px-2 py-1"/></td>
      <td><input type="number" min="1" value="${l.qty}" data-qty="${i}" class="w-16 border rounded px-2 py-1"/></td>
      <td>${(l.price*l.qty).toFixed(2)}</td>
      <td class="no-print"><button data-rm="${i}" class="border rounded px-2 py-1">X</button></td>
    </tr>`).join('');
  tb.querySelectorAll('[data-rm]').forEach(b=> b.addEventListener('click', ()=>{ state.cart.splice(+b.getAttribute('data-rm'),1); renderCart(); }));
  tb.querySelectorAll('[data-qty]').forEach(inp=> inp.addEventListener('input', ()=>{ const i=+inp.dataset.qty; state.cart[i].qty = Math.max(1, +inp.value||1); renderCart(); }));
  tb.querySelectorAll('[data-price]').forEach(inp=> inp.addEventListener('input', ()=>{ const i=+inp.dataset.price; state.cart[i].price = Math.max(0, +inp.value||0); renderCart(); }));
  calcTotals();
}
function calcTotals(){
  const sub = state.cart.reduce((s,l)=> s + l.price*l.qty, 0);
  const discount = +($('#posDiscount').value||0);
  const vatPct = +($('#posVat').value||0);
  const vat = ((sub - discount) * vatPct)/100;
  const tot = sub - discount + vat;
  $('#posSubtotal').textContent = sub.toFixed(2);
  $('#posDiscountAmt').textContent = discount.toFixed(2);
  $('#posVatAmt').textContent = vat.toFixed(2);
  $('#posTotal').textContent = tot.toFixed(2);
  $('#posPrint').disabled = state.cart.length===0;
}
$('#posDiscount')?.addEventListener('input', calcTotals);
$('#posVat')?.addEventListener('input', calcTotals);
$('#posClear')?.addEventListener('click', ()=> { state.cart=[]; renderCart(); });

$('#posPay')?.addEventListener('click', async ()=>{
  if (!state.cart.length) return alert('Cart is empty');
  const today = new Date().toISOString().slice(0,10);
  const invoiceId = 'INV-'+Date.now();
  const vatPct = +($('#posVat').value||0);
  const discount = +($('#posDiscount').value||0);
  // create sale lines
  const lines = state.cart.map(l => ({
    invoiceId, date: today, sku: l.sku, qty: l.qty, price: l.price,
    discount: 0, vat: ((l.price*l.qty - (discount/state.cart.length)) * vatPct)/100,
    total: (l.price*l.qty), cashier: state.user || 'cashier'
  }));
  await recordSaleSafe(lines);
  // reduce local stock
  for (const l of state.cart){
    const it = state.items.find(x=>x.sku===l.sku);
    if (it) it.stock = Math.max(0, (+it.stock||0) - l.qty);
  }
  saveStatePart('items', state.items);
  // save sale locally
  state.sales.push(...lines);
  saveStatePart('sales', state.sales);
  renderDashboard(); renderInventory();
  // print-ready receipt
  fillReceipt(invoiceId, today, lines);
  $('#posPrint').disabled = false;
  alert('Payment processed');
  state.cart=[]; renderCart();
});
$('#posPrint')?.addEventListener('click', ()=> {
  $('#receipt').classList.remove('hidden'); window.print(); $('#receipt').classList.add('hidden');
});
function fillReceipt(inv,date,lines){
  $('#rcptName').textContent = state.business.name;
  $('#rcptAddress').textContent = state.business.address;
  $('#rcptInv').textContent = inv;
  $('#rcptDate').textContent = date;
  const tbody = $('#rcptBody'); tbody.innerHTML='';
  let sub=0; lines.forEach(l=>{ sub += l.price*l.qty; tbody.insertAdjacentHTML('beforeend', `<tr><td>${l.sku} - ${l.name||''}</td><td>${l.qty}</td><td>${l.price.toFixed(2)}</td><td>${(l.price*l.qty).toFixed(2)}</td></tr>`); });
  const discount = +($('#posDiscount').value||0);
  const vat = +($('#posVatAmt').textContent||0);
  const total = +($('#posTotal').textContent||0);
  $('#rcptSub').textContent = sub.toFixed(2);
  $('#rcptDis').textContent = discount.toFixed(2);
  $('#rcptVat').textContent = vat.toFixed(2);
  $('#rcptTot').textContent = total.toFixed(2);
}

// ===== Sales (table & filters) =====
$('#salesFilter')?.addEventListener('click', renderSales);
$('#salesPrint')?.addEventListener('click', ()=> window.print());
function renderSales(){
  const from = $('#salesFrom').value || '0000-01-01';
  const to   = $('#salesTo').value   || '9999-12-31';
  const tb = $('#salesTable tbody'); if (!tb) return;
  const rows = state.sales.filter(s => s.date>=from && s.date<=to);
  const byInvoice = rows.reduce((m, r)=> {
    const k = r.invoiceId; (m[k]=m[k]||{total:0, items:0, cashier:r.cashier, date:r.date}).total += +r.total||0; m[k].items += r.qty||0; return m;
  }, {});
  tb.innerHTML = Object.entries(byInvoice).map(([inv, info])=>`
    <tr class="border-b"><td>${info.date}</td><td>${inv}</td><td>${info.items}</td><td>${info.total.toFixed(2)}</td><td>${info.cashier}</td></tr>
  `).join('');
}

// ===== Settings =====
$('#uAdd')?.addEventListener('click', ()=>{
  const name = $('#uName').value.trim();
  const pass = $('#uPass').value.trim();
  const role = $('#uRole').value;
  if (!name || !pass) return alert('User and password required');
  // local-only demo users (you can later move to backend)
  const users = state.users || [];
  const exists = users.find(u=>u.username===name);
  if (exists){ exists.role=role; } else users.push({ username:name, role, passwordHash: pass });
  saveStatePart('users', users);
  renderUsers();
});
function renderUsers(){
  const tb = $('#uTable tbody'); if (!tb) return;
  tb.innerHTML = (state.users||[]).map(u=>`<tr class="border-b"><td>${u.username}</td><td>${u.role}</td><td></td></tr>`).join('');
}
// Business settings save (live as you type)
$('#setName')?.addEventListener('input', e=> { setBusiness({name:e.target.value}); });
$('#setAddress')?.addEventListener('input', e=> { setBusiness({address:e.target.value}); });
$('#setCur')?.addEventListener('input', e=> { setBusiness({cur:e.target.value}); });

// ===== Dashboard / KPIs =====
function renderDashboard(){
  const itemsCount = state.items.length;
  const stockSum   = state.items.reduce((s,it)=> s + (+it.stock||0), 0);
  const today = new Date().toISOString().slice(0,10);
  const todaySales = state.sales.filter(s=>s.date===today).reduce((s,r)=> s + (+r.total||0), 0);
  const low = state.items.filter(it => (+it.stock||0) <= (+it.reorder||0)).length;

  $('#kpiItems').textContent = itemsCount;
  $('#kpiStock').textContent = stockSum;
  $('#kpiToday').textContent = (todaySales||0).toFixed(2);
  $('#kpiLow').textContent = low;

  // Top selling (by qty)
  const sold = state.sales.reduce((m, r)=> { m[r.sku]=(m[r.sku]||0)+(+r.qty||0); return m; }, {});
  const top = Object.entries(sold).sort((a,b)=>b[1]-a[1]).slice(0,5);
  $('#topSelling').innerHTML = top.map(([sku,qty])=>`<li>${sku} — <b>${qty}</b></li>`).join('') || '<li class="text-slate-400">No sales yet</li>';
  // Low stock list
  $('#lowStock').innerHTML = state.items.filter(it => (+it.stock||0) <= (+it.reorder||0))
    .slice(0,8).map(it=>`<li>${it.sku} — <b>${it.stock||0}</b> (≤ ${it.reorder||0})</li>`).join('') || '<li class="text-slate-400">None</li>';
}

// ===== Initial boot =====
loadState();
$('#setName').value = state.business.name;
$('#setAddress').value = state.business.address;
$('#setCur').value = state.business.cur;
setRole(state.role);
renderUsers(); renderSuppliers(); fillSupplierSelect(); renderInventory(); renderGRN(); renderSales(); renderDashboard();

// Pull now + poll, and try flush queue
window.addEventListener('load', ()=>{
  syncPull();
  setInterval(syncPull, 8000);
  flushQueue();
});
</script>
